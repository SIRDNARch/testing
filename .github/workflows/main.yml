name: Conformance Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Choose random result file
        run: |
          files=("sample1.json.bz2" "sample2.json.bz2" "sample3.json.bz2")

          selected="${files[$RANDOM % ${#files[@]}]}"

          cp "$selected" selected.json.bz2

      - name: Upload results to conformance server
        if: always()
        env:
          API_KEY: ""
          SERVER_URL: ${{ secrets.CONFORMANCE_SERVER_URL }}
        run: |
          response=$(curl -L -s -w "\n%{http_code}" \
            -H "x-api-key: $API_KEY" \
            -H "x-repo-full-name: ${{ github.repository }}" \
            -H "x-run-title: ${{ github.event.pull_request.title || github.event.head_commit.message || '' }}" \
            -H "x-commit-sha: ${{ github.sha }}" \
            -H "x-pr-number: ${{ github.event.pull_request.number || '' }}" \
            -H "x-ref-name: ${{ github.ref_name }}" \
            -H "x-ref-kind: ${{ github.ref_type }}" \
            -H "x-workflow-run-id: ${{ github.run_id }}" \
            -H "x-artifact-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -F "file=@selected.json.bz2" \
            $SERVER_URL/api/upload)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Server response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "Upload failed"
            exit 1
          fi
